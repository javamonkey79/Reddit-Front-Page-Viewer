<html>
	<head>
		<meta content="text/html;charset=utf-8" http-equiv="Content-Type">
		<meta content="utf-8" http-equiv="encoding">
		<link rel="shortcut icon"
      type="image/x-icon"
      href="http://www.redditstatic.com/favicon.ico">
		<script type="text/javascript" src="http://code.jquery.com/jquery-1.7.1.min.js"></script>
		<!-- using the jquery url parser: https://github.com/allmarkedup/jQuery-URL-Parser -->
		<script type="text/javascript" src="https://raw.github.com/allmarkedup/jQuery-URL-Parser/master/purl.js"></script>
		<script type="text/javascript">
			var itemNumber = 0;
			var seenUrls = [];

			function loadAllAndPics(){
				$("#content").html("");

				loadByTimeAndSubreddit("day","all");
				loadByTimeAndSubreddit("day","pics");
				loadByTimeAndSubreddit("day","askreddit");
				loadByUrl('http://www.reddit.com/.json?jsonp=?');
				loadByUrl('http://www.reddit.com/r/pics/.json?jsonp=?');
			}

			function loadByTimeAndSubreddit(time, subreddit) {
				loadByUrl("http://www.reddit.com/r/" + subreddit + "/top/.json?sort=top&t=" + time + "&jsonp=?");
			}

			function loadByUrl(url) {

				$.getJSON( url, function(json) {
				  $.each(json.data.children, function(i,item){
				  	
				  	console.debug(itemNumber);

						var iData = item.data;
						var commentLink = "http://www.reddit.com" + iData.permalink;
						var url = iData.url;

						if( seenUrls.indexOf( url ) != -1 || commentLink.indexOf( "atheism" ) != -1 ){
							return;
						}

						seenUrls.push( url );

						var imgurAlbumPattern = new RegExp("http://imgur\\.com/(a|gallery)/\\w+");
						var imagePattern = new RegExp("\\.(gif|jpg|png|jpeg)");

						var endsWithFileExtension = imagePattern.test( url );
						var imgurAlbum =  imgurAlbumPattern.test( url );

						/*
						console.debug( "url: {" + url + "} - albumImgur: {" + albumImgur +
							"} - extension: {" + extension + "} - endsWithFileExtension: {" + endsWithFileExtension + "}" );
						*/

						var title = iData.title;

						$("<h1>" + title + "</h1>").appendTo("#content");
						$("<a href='"+commentLink+"' target='_blank'>Comments</a>").appendTo("#content");
						appendBreak();

						var imageUrl = endsWithFileExtension ? url : url + ".jpg";
						if( endsWithFileExtension || ( url.indexOf( "imgur" ) != -1 && !imgurAlbum ) ) {
							showImage(commentLink, title, url, imageUrl);
						} else {
							// drop a link to it just in case we can't wrap it in an iframe
							$("<a href='"+url+"' target='_blank'>Open In New Tab</a><br/>").appendTo("#content");

							if((url.indexOf("youtube") != -1 || url.indexOf("youtu.be") != -1) && url.indexOf("charts") == -1){
								showYouTubeContent(url);
							}else if(imgurAlbum) {
								showImgurAlbum(commentLink, title, url);
							}else if(url.indexOf("qkme.me") != -1 || url.indexOf("quickmeme") != -1) {
								showQuickMemeContent(url);
							}else if(url.indexOf("reddit.com") != -1) {
								$("<a href='javascript:void(0)' id='top10_showme"+itemNumber+"' onclick=showTopComments('top10_showme"+itemNumber+"','"+url+"',10)>Show Top 10 Comments</a><br/>").appendTo("#content");
								$("<a href='javascript:void(0)' id='top25_showme"+itemNumber+"' onclick=showTopComments('top25_showme"+itemNumber+"','"+url+"',25)>Show Top 25 Comments</a><br/>").appendTo("#content");
								$("<a href='javascript:void(0)' id='top100_showme"+itemNumber+"' onclick=showTopComments('top100_showme"+itemNumber+"','"+url+"',100)>Show Top 100 Comments</a><br/>").appendTo("#content");
							}else {
								$("<a href='javascript:void(0)' id='showme"+itemNumber+"' onclick=showIFrame('showme"+itemNumber+"','"+url+"')>Show iFrame</a><br/>").appendTo("#content");
							}
						}
						appendBreak();
						itemNumber++;
			    });
				});
			}

			function showImage(commentLink, title, url, imageUrl){
				if( commentLink.indexOf( "nsfw" ) != -1 || title.indexOf( "NSFW" ) != -1 || commentLink.indexOf( "gonewild" ) != -1 ) {
					$("<a href='javascript:void(0)' onclick=showHiddenImage(hiddenImg"+itemNumber+")>Show It!</a><br/>").appendTo("#content");
					$("<a href='"+url+"' target='_blank' style='display:none' id=hiddenImg"+itemNumber+"><img id=redditImg"+itemNumber+" src='"+imageUrl+"' style='width: 75%; height: auto;' /></a>").appendTo("#content");
				} else {
					$("<a href='"+url+"' target='_blank'><img id=redditImg"+itemNumber+" src='"+imageUrl+"' style='width: 75%; height: auto;' /></a>").appendTo("#content");
				}
			}

			function showImgurAlbum(commentLink, title, url){
				if( commentLink.indexOf( "gonewild" ) != -1 ) {
					$("<a href='javascript:void(0)' onclick='showHiddenImage(id=redditFrame"+itemNumber+")'>Show It!</a><br/>").appendTo("#content");
					$("<iframe src='"+url+"' id=redditFrame"+itemNumber+" style='width: 75%; height: 75%; display:none; '/>").appendTo("#content");
				} else {
					$("<iframe src='"+url+"' id=redditFrame"+itemNumber+" style='width: 75%; height: 75%;'/>").appendTo("#content");
				}
			}

			function showTopComments(idAppendTo,url,limit){
				$("<br/>").appendTo("#"+idAppendTo);
				$.getJSON(url+".json?depth=1&sort=top&limit="+limit+"&jsonp=?", function(innerJson) {
  				
  				var newContent = "";
  				
  				$.each(innerJson[1].data.children, function(j,innerItem){
  					if(innerItem.data.body != undefined){
  						newContent += "<div style=\"width: 50%; padding-left:50px;\">"+$("<div/>").html(innerItem.data.body_html).text()+"</div><hr width=50% align=left />";
  					}
  				});
  				
  				$("#"+idAppendTo).after(newContent);
  			});
			}

			function showYouTubeContent(url){
				var parsedUrl = $.url( url );
				var videoId = parsedUrl.param( 'v' );
				if(videoId == undefined){
					var youtubeRegex = /(?:http:\/\/)?(?:www\.)?(?:youtu\.be)\/(.+)/g;
					url = url.replace(youtubeRegex, "http://www.youtube.com/embed/$1")
				}else{
					url = "http://www.youtube.com/embed/" + videoId;
				}

				$("<iframe class='youtube-player' src='"+url+"' style='width: 75%; height: 75%;'/>").appendTo("#content");
			}

			function showQuickMemeContent(url){
				//example #1: http://www.quickmeme.com/meme/3rw7au/ : http://i.qkme.me/3rw7au.jpg
				//example #2: http://qkme.me/3qyjn2 : http://i.qkme.me/3qyjn2.jpg
				//example #3: http://qkme.me/3rwvvj?id=228282463 : http://i.qkme.me/3rwvvj.jpg

				//handle trailing slashes
				if(url.charAt(url.length -1) == '/'){
					url = url.substring(0, url.length -1);
				}

				//handle url params
				var questionMarkLocation = url.indexOf("?")
				if(questionMarkLocation != -1){
					url = url.substring(0,questionMarkLocation);
				}

				var split = url.split("/");
				var imageLoc = split[split.length - 1];

				url = "http://i.qkme.me/" + imageLoc + ".jpg";
				
				$("<a href='"+url+"' target='_blank'><img id=redditImg"+itemNumber+" src='"+url+"' style='width: 75%; height: auto;' /></a>").appendTo("#content");
			}

			function showIFrame(idAppendTo,url){
				$("<br/>").appendTo("#"+idAppendTo);
				$("<iframe src='"+url+"' style='width: 75%; height: 75%;'/>").appendTo("#"+idAppendTo);
			}

			function showHiddenImage(idToShow){
				//console.debug("showing: " + idToShow);
				$(idToShow).css("display", "inline");
			}

			function appendBreak(){
				$("<br/>").appendTo("#content");
			}
		</script>
	</head>
	<body onload="loadAllAndPics()">
		<div id="content" />
	</body>
</html>